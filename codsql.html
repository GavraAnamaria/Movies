<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Cod SQL</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
.button {
  display: inline-block;
  padding: 15px 25px;
  font-size: 20px;
  cursor: pointer;
  text-align: center;	
  text-decoration: none;
  outline: none;
  color: #fff;
  background-color: #f44336;
  border: none;
  border-radius: 15px;
  box-shadow: 0 9px #999;
}

.button:hover {background-color: #f44336}

.button:active {
  background-color: #f44336;
  box-shadow: 0 5px #666;
  transform: translateY(4px);
}
div {
    width: 1200px;
    padding: 15px;
    border: 25px groove;
    margin: 30px;
    text-align: center;
}
body {
    background-color: whitesmoke;
}
table {
    text-align:center;
    margin: auto;
    border: solid 3px;
    border-color: black;
}
th {
    background-color: #f44336;
    color: black;
    border: 3px;
}
td{
    border: solid 1px;
    border-color: black;
    width: 200px;
}
</style> 
    </head>
    <body>
        <div>
            <p style="font-size: 30px; text-align: center">Codul SQL folosit</p> 
            <p style="text-align: center"> 
--------Subiectul 15------ 
<br> Codul SQL pentru partial colocviu, care a fost folosit si pentru crearea aplicatiei
<br> -----15.01-----
<br> Se creaza tabelele Persoana, Deviz, Piesa si Piesa_Deviz
<br>---a---
<br>CREATE TABLE Persoana (
id_p INT NOT NULL,
nume VARCHAR(50) NOT NULL,
telefon CHAR(10) NOT NULL,
adresa VARCHAR(100),
PRIMARY KEY(id_p));
<br>---b---
<br>CREATE TABLE Deviz (
id_d INT NOT NULL,
data_introducere DATE,
aparat VARCHAR(50) NOT NULL,
simptome VARCHAR(100),
defect VARCHAR(100),
data_constatare DATE DEFAULT NULL,
data_finalizare DATE DEFAULT NULL,
durata INT,
manopera_ora INT,
total INT,
id_client INT, 
id_depanator INT,
PRIMARY KEY(id_d));
<Br>---c---
<br>CREATE TABLE Piesa (
id_p INT NOT NULL,
descriere VARCHAR(50),
fabricant VARCHAR(50),
pret_c INT,
PRIMARY KEY(id_p));
<br>---d---
<br>CREATE TABLE Piesa_Deviz (
id_d INT,
id_p INT,
cantitate INT,
pret INT,
sursa VARCHAR(50));
<br>---e---
<br> Se adauga cheile straine
<br>ALTER TABLE Deviz ADD FOREIGN KEY (id_client) REFERENCES Persoana(id_p);
ALTER TABLE Piesa_Deviz ADD FOREIGN KEY (id_d) REFERENCES Deviz(id_d);
ALTER TABLE Piesa_Deviz ADD FOREIGN KEY (id_p) REFERENCES Piesa(id_p);
<br>---f---
<br>ALTER TABLE Persoana DROP COLUMN adresa;
<br>---Introducere date---
<Br>INSERT INTO Persoana VALUES(1,'Popescu Simina','0740827047');
<Br>INSERT INTO Persoana VALUES(2,'Sasaran Dana','0752643371');
<br>INSERT INTO Persoana VALUES(3,'Nedela Raul','0732154238');
<br>INSERT INTO Persoana VALUES(4,'Butean Marcu','0749021432');
<br>INSERT INTO Persoana VALUES(5,'Pop Vlad','078239330');
<br>INSERT INTO Persoana VALUES(6,'Simon Bettina','0760423458');
<br>
<br>INSERT INTO Deviz(id_d,data_introducere,aparat,simptome) VALUES(1,'28 NOVEMBER 2015', 'iPhone 5S', 'Ecranul este spart');
<br>INSERT INTO Deviz VALUES(2,'18 MAY 2015', 'iPhone 3GS', 'Nu se aprinde ecranul cand apas pe butonul de meniu', 'Butonul de meniu nu functioneaza', '18 MAY 2015', '20 MAY 2015',8,40,48,2,1);
<br>INSERT INTO Deviz VALUES(3,'7 SEPTEMBER 2015', 'Samsung 5', 'Nu se aude nimic', 'Placa de baza nefunctionala', '7 SEPTEMBER 2015', '8 SEPTEMBER 2015',10,50,60,3,1);
<br>INSERT INTO Deviz VALUES(4,'8 NOVEMBER 2015', 'Nokia 5530', 'Nu se aprinde', 'Butonul de start', '8 NOVEMBER 2015', '11 NOVEMBER 2015',5,20,25,4,3);
<br>INSERT INTO Deviz VALUES(5,'9 NOVEMBER 2014', 'PlayStation 4', 'Nu merg jocurile', 'CD Player stricat', '9 NOVEMBER 2015',NULL,8,60,68,1,2);
<br>INSERT INTO Deviz(id_d, data_introducere,aparat,defect,data_constatare,id_client) VALUES(6,'24 NOVEMBER 2015','Cuptor cu microunde','Nu porneste','25 NOVEMBER 2015',6);
<br>INSERT INTO Deviz VALUES(7,'17 SEPTEMBER 2015', 'Samsung 5', 'Nu se vede nimic', 'Pixel morit', '17 SEPTEMBER 2015', '20 SEPTEMBER 2015',23,80,103,5,5);
<br>INSERT INTO Deviz VALUES(8,'14 JUNE 2014','iPhone 3GS','Nu merge sonorul','Butonul de mut','14 JUNE 2014','14 JUNE 2014',4,20,24,4,3);
<br>INSERT INTO Deviz(id_d,data_introducere,aparat,id_client) VALUES(9,'26 NOVEMBER 2015','iPhone 5S',3);
<br>INSERT INTO Deviz(id_d,data_introducere,aparat,data_constatare,id_client) VALUES(10,'26 NOVEMBER 2015','iPhone 6',NULL,5);
<br>INSERT INTO Deviz VALUES(11,'13 MARCH 2013','iPhone 3GS','Nu merge ecranul','Placa de baza','13 MARCH 2013','17 MARCH 2013',8,30,38,1,1);
<br>INSERT INTO Deviz VALUES(12,'14 JUNE 2013','iPhone 3GS','Nu merge sonorul','Butonul de mut','15 JUNE 2013','18 JUNE 2013',6,30,36,1,2);
<br>
<br>INSERT INTO Piesa VALUES(1,'Ecran iPhone 5S','Apple',200);
<br>INSERT INTO Piesa VALUES(2,'Buton meniu iPhone3GS','Apple',50);
<br>INSERT INTO Piesa VALUES(3,'Ecran iPhone 6','Apple',300);
<br>INSERT INTO Piesa VALUES(4,'CD Player','Sony',500);
<br>INSERT INTO Piesa VALUES(5,'Ecran iPhone 3GS','Apple',100);
<br>INSERT INTO Piesa VALUES(6,'Placa de baza iPhone 3GS','Apple',150);
<br>INSERT INTO Piesa VALUES(7,'Placa de baza Samsung 5','Samsung',300);
<br>INSERT INTO Piesa VALUES(8,'Buton de pornire Nokia 5530','Nokia',50);
<br>INSERT INTO Piesa VALUES(9,'Placa de baza, Dell','Dell',500);
<br>INSERT INTO Piesa VALUES(10, 'Cablu de alimentare', 'Samsung',80);
<br>INSERT INTO Piesa VALUES(11,'Ecran Samsung 5','Samsung',200);
<br>INSERT INTO Piesa VALUES(12,'Buton sonor iPhone3GS','Apple',30);
<br>
<br>INSERT INTO Piesa_Deviz VALUES(2,2,1,50,'Apple');
<br>INSERT INTO Piesa_Deviz VALUES(3,7,1,50,'Samsung');
<br>INSERT INTO Piesa_Deviz VALUES(4,8,1,50,'Nokia');
<br>INSERT INTO Piesa_Deviz VALUES(5,4,1,500,'Sony');
<br>INSERT INTO Piesa_Deviz VALUES(6,10,1,80,'Samsung');
<br>INSERT INTO Piesa_Deviz VALUES(7,11,1,200,'Samsung');
<br>INSERT INTO Piesa_Deviz VALUES(8,12,2,60,'Apple');
<br>INSERT INTO Piesa_Deviz VALUES(11,6,1,150,'Apple');
<br>INSERT INTO Piesa_Deviz VALUES(12,12,1,60,'Altex');
<br>
<br>-----15.02----
<br>Adaugarea Constrangerilor
<br>---a---
<br>ALTER TABLE Deviz ADD CONSTRAINT VerificareData CHECK (data_finalizare>=data_constatare);
<br>---b---
<br>ALTER TABLE Piesa_Deviz ADD CONSTRAINT VerificareCantitate CHECK(cantitate>=1);

<br>-----15.03----
<br>Interogarile facute si in aplicatie
<br>---a---
<br>SELECT id_d,data_introducere,aparat,simptome
FROM Deviz
WHERE data_constatare IS NULL;
<br>---b---
<br>SELECT * 
FROM Deviz 
WHERE EXTRACT(MONTH FROM data_finalizare)='03' AND EXTRACT(YEAR FROM data_finalizare)='2013';

<br>-----15.04-----
<br>---a---
<br>SELECT descriere,fabricant,sursa,cantitate,pret
FROM Piesa_Deviz INNER JOIN Piesa ON Piesa_Deviz.id_p=7 
WHERE Piesa.id_p=Piesa_Deviz.id_p;
<br>---b---
<br>SELECT d1.id_d AS id_d1,d2.id_d AS id_d2 
FROM Deviz d1 INNER JOIN Deviz d2 ON d1.aparat=d2.aparat AND d1.id_client=d2.id_client 
WHERE d1.id_d<d2.id_d;

<br>-----15.05-----
<br>---a---
<br>SELECT DISTINCT p1.id_p FROM Piesa p1 JOIN Piesa p2 ON p1.fabricant=p2.fabricant INNER JOIN piesa_deviz d1 JOIN piesa_deviz d2 ON d1.sursa<>d2.sursa WHERE p1.id_p=EXISTS(SELECT d1.id_p FROM piesa_deviz WHERE d1.sursa<>d2.sursa"
<br>---b---
<br>SELECT id_p 
FROM Piesa 
WHERE pret_c=(SELECT MIN(pret_c) FROM Piesa);

<br>-----15.06-----
<br>---a---
<br>SELECT nume
FROM Persoana
WHERE id_p=(SELECT id_client 
            FROM Deviz 
            WHERE data_introducere=(SELECT MIN(data_introducere) FROM Deviz));
<br>---b---
<br>SELECT Deviz.id_d,SUM(Piesa_Deviz.cantitate) 
FROM Deviz INNER JOIN Piesa_Deviz ON Piesa_Deviz.id_d=Deviz.id_d
GROUP BY Deviz.id_d ORDER BY Deviz.id_d ASC;

<br>-----15.07-----
<br>Operatiile de introducere, sterge si actualizare a tabelei
<br>---a---
<br>INSERT INTO Deviz(id_d,data_introducere,aparat,simptome,id_client,id_depanator) VALUES(45,'15 MAY 2013','TV Samsung','imagine desincronizata',101,27);
<br>---b---
<br>DELETE FROM Piesa WHERE Piesa.id_p<>ALL(SELECT id_p FROM Piesa_Deviz);
<br>---c---
<br>UPDATE Deviz SET manopera_ora=manopera_ora+0.25*manopera_ora;

<br>-----15.08-----
<br>Triggerele create pentru functionarea tabelei
<br>---a---
<br>create or replace TRIGGER ACTUALIZARETOTAL 
AFTER DELETE OR INSERT OR UPDATE 
ON Piesa_Deviz 
FOR EACH ROW 
BEGIN
  UPDATE Deviz
  SET total=durata*manopera_ora+(Select pret FROM Piesa_Deviz);
END;
<br>---b---
<br>create or replace TRIGGER DEPASIRETERMEN 
AFTER UPDATE OR INSERT ON Deviz
FOR EACH ROW 
BEGIN
   INSERT INTO DEPASIRI_TERMEN SELECT id_d 
                               FROM Deviz 
                               WHERE (EXTRACT(DAY FROM data_introducere)+15>=EXTRACT(DAY FROM data_finalizare));
END;
<br>---c---
<br>create or replace TRIGGER INTRODUCEREVEDERE 
INSTEAD OF INSERT OR UPDATE ON Devize_Popescu 
REFERENCING OLD AS OLD NEW AS NEW 
FOR EACH ROW 
<br>BEGIN
  <br>INSERT INTO DEVIZE_POPESCU
 <br> SELECT p1.id_p,p1.nume,p1.telefon,d1.id_d,d1.data_introducere,d1.aparat,d1.simptome,d1.defect,<br>d1.data_constatare,d1.data_finalizare,d1.durata,d1.manopera_ora,d1.total,p2.descriere,d2.cantitate,d2.pret,d2.sursa
  <br>FROM Deviz d1 INNER JOIN Persoana p1 ON  (p1.id_p=d1.id_client)
     JOIN Piesa_Deviz d2 ON (d1.id_d=d2.id_d)
     JOIN Piesa p2 ON (d2.id_p=p2.id_p)
  <br>WHERE id_depanator IN(SELECT id_p FROM Persoana WHERE nume='Popescu Simina');
END;
<br>Vederea creata
<br>Creare view
SELECT p1.id_p,p1.nume,p1.telefon,d1.id_d,d1.data_introducere,d1.aparat,d1.simptome,d1.defect,<br>d1.data_constatare,d1.data_finalizare,d1.durata,d1.manopera_ora,d1.total,p2.descriere,d2.cantitate,d2.pret,d2.sursa
<br>FROM Deviz d1 INNER JOIN Persoana p1 ON  (p1.id_p=d1.id_client)
     JOIN Piesa_Deviz d2 ON (d1.id_d=d2.id_d)
     JOIN Piesa p2 ON (d2.id_p=p2.id_p)
<br>WHERE id_depanator IN(SELECT id_p FROM Persoana WHERE nume='Popescu Simina')
            </p>
            <a href="index.html" class="button">Inapoi</a>
        </div>
    </body>
</html>
